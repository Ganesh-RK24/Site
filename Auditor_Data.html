<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditor Data Upload & Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Base Reset */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 1100px;
      width: 100%;
    }

    h2 {
      color: #4a90e2;
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 2.2rem;
      user-select: none;
    }

    .section, .upload-section, .filter-section {
      background: #1f1f1f;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(74, 144, 226, 0.6);
      margin-bottom: 25px;
      user-select: none;
    }

    h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #4a90e2;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 18px;
    }

    .form-row > * {
      flex: 1 1 200px;
      min-width: 150px;
    }

    input[type="file"],
    input[type="date"],
    select,
    input[type="number"],
    input[type="text"],
    button {
      padding: 14px 16px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: #eee;
      font-size: 1rem;
      width: 100%;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
      font-weight: 600;
      outline-offset: 2px;
      outline-color: transparent;
      outline-style: solid;
      outline-width: 2px;
      cursor: pointer;
      user-select: none;
    }

    input[type="file"]::-webkit-file-upload-button {
      background: #4a90e2;
      color: #fff;
      border: none;
      padding: 10px 18px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 700;
      transition: background-color 0.25s ease;
    }

    input[type="file"]::-webkit-file-upload-button:hover {
      background: #357ABD;
    }

    input[type="file"]:focus-visible::-webkit-file-upload-button {
      outline: 3px solid #4a90e2;
      outline-offset: 1px;
    }

    input[type="file"]:focus-visible {
      outline: 3px solid #4a90e2;
      outline-offset: 3px;
    }

    input[type="date"]:focus,
    select:focus,
    input[type="number"]:focus,
    input[type="text"]:focus,
    button:focus {
      background-color: #444;
      outline-color: #4a90e2;
      box-shadow: 0 0 6px #4a90e2;
    }

    button {
      background-color: #4a90e2;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      min-width: 160px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #357ABD;
    }

    button:disabled,
    button[disabled] {
      background-color: #555;
      cursor: not-allowed;
      color: #bbb;
    }

    .message {
      margin-top: 12px;
      font-weight: 700;
      min-height: 24px;
      user-select: text;
      font-size: 1rem;
      transition: color 0.3s ease;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #222;
      color: #eee;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
      table-layout: fixed;
      word-wrap: break-word;
      user-select: text;
      max-height: 450px;
      display: block;
      overflow-y: auto;
    }

    thead {
      display: table;
      width: 100%;
      table-layout: fixed;
      background-color: #4a90e2;
      font-weight: 700;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tbody {
      display: block;
      width: 100%;
      max-height: 450px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #4a90e2 #121212;
    }

    tbody::-webkit-scrollbar {
      width: 10px;
    }

    tbody::-webkit-scrollbar-track {
      background: #121212;
    }

    tbody::-webkit-scrollbar-thumb {
      background-color: #4a90e2;
      border-radius: 10px;
      border: 3px solid #121212;
    }

    tr {
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    th, td {
      padding: 14px 16px;
      border-bottom: 1px solid #444;
      text-align: left;
      overflow-wrap: break-word;
    }

    tr:hover {
      background-color: #333;
    }

    .download-button {
      background-color: #4caf50;
      color: white;
      font-weight: 700;
      padding: 14px 0;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      min-width: 160px;
      height: 48px;
      transition: background-color 0.3s ease;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .download-button:hover {
      background-color: #388e3c;
    }

    @media (max-width: 650px) {
      .form-row {
        flex-direction: column;
      }
      .form-row > * {
        flex: 1 1 100%;
        min-width: auto;
      }
      table {
        font-size: 0.9rem;
      }
      button, .download-button {
        width: 100%;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Auditor Data Upload & Reports</h2>

    <!-- Manpower Section -->
    <div class="section">
      <h3>üßë‚Äçüîß Manpower Data Entry</h3>
      <div class="form-row">
        <input type="date" id="mpDate" aria-label="Manpower Date" />
        <select id="mpWarehouse" aria-label="Manpower Warehouse">
          <option value="">Select Warehouse</option>
          <option value="W501">W501</option>
          <option value="W503">W503</option>
          <option value="W504">W504</option>
          <option value="W506">W506</option>
          <option value="W509">W509</option>
          <option value="W511">W511</option>
          <option value="W512">W512</option>
        </select>
        <select id="mpVendor" aria-label="Manpower Vendor">
          <option value="">Select Vendor</option>
          <option value="Matrix Business Services India Private Limited">Matrix Business Services India Private Limited</option>
          <option value="PRO-Team Solution Pvt Ltd">PRO-Team Solution Pvt Ltd</option>
        </select>
        <input type="number" id="mpCount" placeholder="MP Count" aria-label="Manpower Count" min="0" />
      </div>
      <button id="submitMP" type="button">Submit Manpower Entry</button>
      <div class="message" id="mpMessage" role="alert" aria-live="polite"></div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h3>üì§ Please Upload Counted Data ‚¨ÜÔ∏è</h3>
      <div class="form-row">
        <input type="file" id="fileInput" accept=".csv" aria-label="CSV File Input" />
        <button id="uploadBtn" type="button">üì§ Upload CSV</button>
      </div>
      <div class="message" id="message" role="alert" aria-live="polite"></div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section" aria-label="Filter Section">
      <div class="form-row">
        <input type="date" id="fromDate" placeholder="From Date" aria-label="From Date Filter" />
        <input type="date" id="toDate" placeholder="To Date" aria-label="To Date Filter" />
        <select id="filterWarehouse" aria-label="Warehouse Filter">
          <option value="">All Warehouses</option>
          <option value="W501">W501</option>
          <option value="W503">W503</option>
          <option value="W504">W504</option>
          <option value="W506">W506</option>
          <option value="W509">W509</option>
          <option value="W511">W511</option>
          <option value="W512">W512</option>
        </select>
      </div>
      <div class="form-row">
        <button id="filterBtn" type="button">Filter</button>
        <button class="download-button" id="downloadCsvBtn" type="button">Download CSV</button>
      </div>
    </div>

    <table id="dataTable" aria-label="Auditor Data Table" role="grid">
      <thead>
        <tr>
          <th scope="col">Counted Date</th>
          <th scope="col">Warehouse No</th>
          <th scope="col">Auditor</th>
          <th scope="col">Bin Code</th>
          <th scope="col">Verified</th>
          <th scope="col">Scanned Qty</th>
          <th scope="col">Auditor Qty</th>
          <th scope="col">Mismatch</th>
          <th scope="col">Reverified</th>
          <th scope="col">Reverified Phy Qty</th>
          <th scope="col">Final Remarks</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const SUPABASE_URL = 'https://japvvcwuvmstkaljcttu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcHZ2Y3d1dm1zdGthbGpjdHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA4ODAsImV4cCI6MjA3NTQwNjg4MH0.1wAmrpCxGnCBgV2hOQEn5X7zRsKtbyRaTTqlvuojVYY';
    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_KEY);

    let auditorData = [];

    const mpDate = document.getElementById('mpDate');
    const mpWarehouse = document.getElementById('mpWarehouse');
    const mpVendor = document.getElementById('mpVendor');
    const mpCount = document.getElementById('mpCount');
    const submitMP = document.getElementById('submitMP');
    const mpMessage = document.getElementById('mpMessage');

    submitMP.addEventListener('click', async () => {
      mpMessage.textContent = '';
      if (!mpDate.value || !mpWarehouse.value || !mpVendor.value || !mpCount.value) {
        mpMessage.style.color = '#f44336';
        mpMessage.textContent = '‚ùå Please fill all fields.';
        return;
      }

      const { error } = await client
        .from('Manpower_Data')
        .insert([{
          Date: mpDate.value,
          "Warehouse No": mpWarehouse.value,
          Vendor: mpVendor.value,
          "MP Count": parseInt(mpCount.value, 10)
        }]);

      if (error) {
        mpMessage.style.color = '#f44336';
        mpMessage.textContent = `‚ùå Failed to submit: ${error.message}`;
      } else {
        mpMessage.style.color = '#4caf50';
        mpMessage.textContent = '‚úÖ Manpower data submitted successfully!';
        mpDate.value = '';
        mpWarehouse.value = '';
        mpVendor.value = '';
        mpCount.value = '';
      }
    });

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const messageDiv = document.getElementById('message');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const filterWarehouse = document.getElementById('filterWarehouse');
    const filterBtn = document.getElementById('filterBtn');
    const downloadBtn = document.getElementById('downloadCsvBtn');
    const dataTableBody = document.querySelector('#dataTable tbody');

    uploadBtn.addEventListener('click', async () => {
      messageDiv.textContent = '';
      if (!fileInput.files.length) {
        messageDiv.style.color = '#f44336';
        messageDiv.textContent = '‚ùå Please select a CSV file.';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          let csvText = e.target.result;
          let jsonData = csvToJson(csvText);
          jsonData = normalizeDateFields(jsonData);

          const { error } = await client.from('Auditor_Counted').insert(jsonData);

          if (error) {
            messageDiv.style.color = '#f44336';
            messageDiv.textContent = `‚ùå Upload failed: ${error.message}`;
          } else {
            messageDiv.style.color = '#4caf50';
            messageDiv.textContent = `‚úÖ Uploaded ${jsonData.length} rows.`;
            loadFromSupabase();
            fileInput.value = null;
          }
        } catch (err) {
          messageDiv.style.color = '#f44336';
          messageDiv.textContent = '‚ùå Error parsing/uploading CSV.';
        }
      };
      reader.readAsText(file);
    });

    function csvToJson(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        // Handle quoted CSV and commas inside quotes (basic)
        const values = parseCsvLine(line);
        const obj = {};
        headers.forEach((header, idx) => obj[header] = values[idx] || '');
        return obj;
      });
    }

    // Basic CSV parser for lines, handling quoted commas
    function parseCsvLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Convert any date fields to ISO YYYY-MM-DD for Supabase
    function normalizeDateFields(data) {
      return data.map(row => {
        if (row['Counted Date']) {
          // Try to parse and convert to YYYY-MM-DD
          let d = new Date(row['Counted Date']);
          if (!isNaN(d)) {
            row['Counted Date'] = d.toISOString().slice(0, 10);
          }
        }
        return row;
      });
    }

    async function loadFromSupabase() {
      messageDiv.textContent = '';
      const { data, error } = await client.from('Auditor_Counted').select('*').order('Counted Date', { ascending: false });

      if (error) {
        messageDiv.style.color = '#f44336';
        messageDiv.textContent = `‚ùå Error loading data: ${error.message}`;
        return;
      }
      auditorData = data;
      displayData(data);
    }

    function displayData(data) {
      dataTableBody.innerHTML = '';
      if (!data.length) {
        dataTableBody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 20px; color:#aaa;">No records found</td></tr>`;
        return;
      }

      data.forEach(row => {
        const tr = document.createElement('tr');

        const mismatch = (parseInt(row['Scanned Qty']) || 0) - (parseInt(row['Auditor Qty']) || 0);
        const verified = row['Verified'] === 'Yes' || row['Verified'] === true ? 'Yes' : 'No';
        const reverified = row['Reverified'] === 'Yes' || row['Reverified'] === true ? 'Yes' : 'No';

        tr.innerHTML = `
          <td>${row['Counted Date'] || ''}</td>
          <td>${row['Warehouse No'] || ''}</td>
          <td>${row['Auditor'] || ''}</td>
          <td>${row['Bin Code'] || ''}</td>
          <td>${verified}</td>
          <td>${row['Scanned Qty'] || ''}</td>
          <td>${row['Auditor Qty'] || ''}</td>
          <td>${mismatch}</td>
          <td>${reverified}</td>
          <td>${row['Reverified Phy Qty'] || ''}</td>
          <td>${row['Final Remarks'] || ''}</td>
        `;

        dataTableBody.appendChild(tr);
      });
    }

    filterBtn.addEventListener('click', () => {
      let filtered = [...auditorData];

      if (fromDate.value) {
        filtered = filtered.filter(r => r['Counted Date'] >= fromDate.value);
      }
      if (toDate.value) {
        filtered = filtered.filter(r => r['Counted Date'] <= toDate.value);
      }
      if (filterWarehouse.value) {
        filtered = filtered.filter(r => r['Warehouse No'] === filterWarehouse.value);
      }

      displayData(filtered);
    });

    downloadBtn.addEventListener('click', () => {
      if (!auditorData.length) {
        alert('No data to download.');
        return;
      }

      let filtered = [...auditorData];
      if (fromDate.value) {
        filtered = filtered.filter(r => r['Counted Date'] >= fromDate.value);
      }
      if (toDate.value) {
        filtered = filtered.filter(r => r['Counted Date'] <= toDate.value);
      }
      if (filterWarehouse.value) {
        filtered = filtered.filter(r => r['Warehouse No'] === filterWarehouse.value);
      }

      const headers = ["Counted Date","Warehouse No","Auditor","Bin Code","Verified","Scanned Qty","Auditor Qty","Mismatch","Reverified","Reverified Phy Qty","Final Remarks"];
      const csvRows = [];
      csvRows.push(headers.join(','));

      filtered.forEach(row => {
        const mismatch = (parseInt(row['Scanned Qty']) || 0) - (parseInt(row['Auditor Qty']) || 0);
        const values = [
          row['Counted Date'] || '',
          row['Warehouse No'] || '',
          row['Auditor'] || '',
          row['Bin Code'] || '',
          row['Verified'] === true || row['Verified'] === 'Yes' ? 'Yes' : 'No',
          row['Scanned Qty'] || '',
          row['Auditor Qty'] || '',
          mismatch,
          row['Reverified'] === true || row['Reverified'] === 'Yes' ? 'Yes' : 'No',
          row['Reverified Phy Qty'] || '',
          row['Final Remarks'] || ''
        ].map(val => {
          if (typeof val === 'string' && val.includes(',')) {
            return `"${val.replace(/"/g, '""')}"`; // escape quotes
          }
          return val;
        });
        csvRows.push(values.join(','));
      });

      const csvString = csvRows.join('\n');
      const blob = new Blob([csvString], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'auditor_data.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Initial data load
    loadFromSupabase();
  </script>
</body>
</html>
