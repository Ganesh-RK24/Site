<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditor Data Upload & Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 20px; }
    .container { max-width: 100%; margin: 0 auto; }
    h2 { color: #4a90e2; margin-bottom: 20px; }
    .section, .upload-section, .filter-section { background: #1f1f1f; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px #4a90e2; margin-bottom: 20px; }
    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; }
    .form-row > * { flex: 1 1 200px; }
    input[type="file"], input[type="date"], select, input[type="number"], input[type="text"], button { padding: 12px; border-radius: 6px; border: none; background-color: #333; color: #eee; width: 100%; box-sizing: border-box; }
    input[type="file"]::-webkit-file-upload-button { background: #4a90e2; color: #fff; border: none; padding: 8px 14px; cursor: pointer; border-radius: 6px; }
    input[type="file"]::-webkit-file-upload-button:hover { background: #357ABD; }
    button { background-color: #4a90e2; font-weight: 700; cursor: pointer; }
    button:hover { background-color: #357ABD; }
    .message { margin-top: 10px; font-weight: 700; min-height: 24px; }
    table { width: 100%; border-collapse: collapse; background: #222; color: #eee; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px 15px; border-bottom: 1px solid #444; text-align: left; }
    th { background-color: #4a90e2; }
    tr:hover { background-color: #333; }
    .download-button { background-color: #4caf50; color: white; font-weight: 700; padding: 12px; border-radius: 6px; cursor: pointer; border: none; width: 100%; }
    .download-button:hover { background-color: #388e3c; }
    .pagination { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
    .pagination button { background-color: #4a90e2; border: none; color: white; padding: 8px 14px; border-radius: 5px; cursor: pointer; font-weight: 600; }
    .pagination button:disabled { background-color: #666; cursor: not-allowed; }
    .pagination input { padding: 6px 8px; border-radius: 5px; border: none; text-align: center; width: 60px; }
  </style>
</head>
<body>
<div class="container">
  <h2>Auditor Data Upload & Reports</h2>

  <!-- Manpower Section -->
  <div class="section">
    <h3>üßë‚Äçüîß Manpower Data Entry</h3>
    <div class="form-row">
      <input type="date" id="mpDate" />
      <select id="mpWarehouse">
        <option value="">Select Warehouse</option>
        <option value="W501">W501</option>
        <option value="W503">W503</option>
        <option value="W504">W504</option>
        <option value="W506">W506</option>
        <option value="W509">W509</option>
        <option value="W511">W511</option>
        <option value="W512">W512</option>
      </select>
      <select id="mpVendor">
        <option value="">Select Vendor</option>
        <option value="Matrix Business Services India Private Limited">Matrix Business Services India Private Limited</option>
        <option value="PRO-Team Solution Pvt Ltd">PRO-Team Solution Pvt Ltd</option>
      </select>
      <input type="number" id="mpCount" placeholder="MP Count" />
    </div>
    <button id="submitMP">Submit Manpower Entry</button>
    <div class="message" id="mpMessage"></div>
  </div>

  <!-- Upload Section -->
  <div class="upload-section">
    <h3>üì§ Please Upload Counted Data ‚¨ÜÔ∏è</h3>
    <div class="form-row">
      <input type="file" id="fileInput" accept=".csv" />
      <button id="uploadBtn">üì§ Upload CSV</button>
    </div>
    <div class="message" id="message"></div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="form-row">
      <input type="date" id="fromDate" placeholder="From Date" />
      <input type="date" id="toDate" placeholder="To Date" />
      <select id="filterWarehouse">
        <option value="">All Warehouses</option>
        <option value="W501">W501</option>
        <option value="W503">W503</option>
        <option value="W504">W504</option>
        <option value="W506">W506</option>
        <option value="W509">W509</option>
        <option value="W511">W511</option>
        <option value="W512">W512</option>
      </select>
    </div>
    <div class="form-row" style="gap: 15px;">
      <button id="filterBtn" style="flex:1 1 auto;">Filter</button>
      <button class="download-button" id="downloadCsvBtn" style="flex:1 1 auto;">Download CSV</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Counted Date</th>
        <th>Warehouse No</th>
        <th>Auditor</th>
        <th>Bin Code</th>
        <th>Verified</th>
        <th>Scanned Qty</th>
        <th>Auditor Qty</th>
        <th>Mismatch</th>
        <th>Reverified</th>
        <th>Reverified Phy Qty</th>
        <th>Final Remarks</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>
</div>

<script>
const SUPABASE_URL = 'https://japvvcwuvmstkaljcttu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcHZ2Y3d1dm1zdGthbGpjdHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA4ODAsImV4cCI6MjA3NTQwNjg4MH0.1wAmrpCxGnCBgV2hOQEn5X7zRsKtbyRaTTqlvuojVYY';
const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

let auditorData = [];
let currentPage = 1;
const pageSize = 100;

const mpDate = document.getElementById('mpDate');
const mpWarehouse = document.getElementById('mpWarehouse');
const mpVendor = document.getElementById('mpVendor');
const mpCount = document.getElementById('mpCount');
const submitMP = document.getElementById('submitMP');
const mpMessage = document.getElementById('mpMessage');

submitMP.addEventListener('click', async () => {
  mpMessage.textContent = '';
  if (!mpDate.value || !mpWarehouse.value || !mpVendor.value || !mpCount.value) {
    mpMessage.style.color = '#f44336';
    mpMessage.textContent = '‚ùå Please fill all fields.';
    return;
  }

  const { error } = await client
    .from('Manpower_Data')
    .insert([{
      Date: mpDate.value,
      "Warehouse No": mpWarehouse.value,
      Vendor: mpVendor.value,
      "MP Count": parseInt(mpCount.value)
    }]);

  if (error) {
    mpMessage.style.color = '#f44336';
    mpMessage.textContent = `‚ùå Failed to submit: ${error.message}`;
  } else {
    mpMessage.style.color = '#4caf50';
    mpMessage.textContent = '‚úÖ Manpower entry submitted successfully';
    mpDate.value = '';
    mpWarehouse.value = '';
    mpVendor.value = '';
    mpCount.value = '';
  }
});

const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const message = document.getElementById('message');

uploadBtn.addEventListener('click', async () => {
  if (!fileInput.files[0]) {
    message.style.color = '#f44336';
    message.textContent = '‚ùå Please select a CSV file to upload.';
    return;
  }
  const file = fileInput.files[0];
  const text = await file.text();
  const rows = text.split('\n').map(r => r.split(','));
  const headers = rows[0].map(h => h.trim());
  const data = rows.slice(1).map(r => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = r[i] ? r[i].trim() : null);
    return obj;
  });

  const { error } = await client.from('Auditor_Data').insert(data);
  if (error) {
    message.style.color = '#f44336';
    message.textContent = `‚ùå Upload failed: ${error.message}`;
  } else {
    message.style.color = '#4caf50';
    message.textContent = '‚úÖ CSV uploaded successfully';
    fileInput.value = '';
    fetchData();
  }
});

const dataTableBody = document.querySelector('#dataTable tbody');
const paginationDiv = document.getElementById('pagination');
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
const filterWarehouse = document.getElementById('filterWarehouse');
const filterBtn = document.getElementById('filterBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');

filterBtn.addEventListener('click', () => { currentPage = 1; fetchData(); });

async function fetchData() {
  let query = client.from('Auditor_Data').select('*');

  if (fromDate.value) query = query.gte('Counted Date', fromDate.value);
  if (toDate.value) query = query.lte('Counted Date', toDate.value);
  if (filterWarehouse.value) query = query.eq('Warehouse No', filterWarehouse.value);

  const { data, error } = await query;
  if (error) { alert('Error fetching data: ' + error.message); return; }

  auditorData = data || [];
  renderTable();
}

function renderTable() {
  const start = (currentPage - 1) * pageSize;
  const pageData = auditorData.slice(start, start + pageSize);
  dataTableBody.innerHTML = '';
  pageData.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row['Counted Date'] || ''}</td>
      <td>${row['Warehouse No'] || ''}</td>
      <td>${row['Auditor'] || ''}</td>
      <td>${row['Bin Code'] || ''}</td>
      <td>${row['Verified'] || ''}</td>
      <td>${row['Scanned Qty'] || ''}</td>
      <td>${row['Auditor Qty'] || ''}</td>
      <td>${row['Mismatch'] || ''}</td>
      <td>${row['Reverified'] || ''}</td>
      <td>${row['Reverified Phy Qty'] || ''}</td>
      <td>${row['Final Remarks'] || ''}</td>
    `;
    dataTableBody.appendChild(tr);
  });

  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(auditorData.length / pageSize);
  paginationDiv.innerHTML = '';

  const createBtn = (text, disabled, clickFn) => {
    const btn = document.createElement('button');
    btn.textContent = text;
    if (disabled) btn.disabled = true;
    btn.addEventListener('click', clickFn);
    paginationDiv.appendChild(btn);
  };

  createBtn('Prev', currentPage === 1, () => { currentPage--; renderTable(); });

  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.style.fontWeight = i === currentPage ? 'bold' : 'normal';
    btn.addEventListener('click', () => { currentPage = i; renderTable(); });
    paginationDiv.appendChild(btn);
  }

  const input = document.createElement('input');
  input.type = 'number';
  input.min = 1;
  input.max = totalPages;
  input.placeholder = 'Page';
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const val = parseInt(input.value);
      if (!isNaN(val) && val >= 1 && val <= totalPages) { currentPage = val; renderTable(); }
    }
  });
  paginationDiv.appendChild(input);

  createBtn('Next', currentPage === totalPages, () => { currentPage++; renderTable(); });
}

downloadCsvBtn.addEventListener('click', () => {
  if (!auditorData.length) return;
  const headers = Object.keys(auditorData[0]);
  const csvRows = [headers.join(',')];
  auditorData.forEach(row => {
    csvRows.push(headers.map(h => `"${row[h] || ''}"`).join(','));
  });
  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'auditor_data.csv';
  a.click();
  URL.revokeObjectURL(url);
});

fetchData();
</script>
</body>
</html>

