<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auditor Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body {font-family: 'Segoe UI', sans-serif; margin:0; background:#f5f5f5;}
  header {
    background:#1976d2; color:white; padding:12px 20px;
    display:flex; align-items:center; justify-content:space-between;
  }
  header h1 {margin:0; font-size:20px;}
  .back-btn {
    background:white; color:#1976d2; font-weight:600;
    border:none; border-radius:6px; padding:8px 14px;
    cursor:pointer; font-size:14px;
    transition:all 0.2s ease;
  }
  .back-btn:hover {background:#e3f2fd;}
  
  .container {display:flex; height:calc(100vh - 60px);}
  .sidebar {width:220px; background:#fff; border-right:1px solid #ddd; padding-top:10px; box-shadow:2px 0 5px rgba(0,0,0,0.05);}
  .sidebar button {display:block; width:100%; padding:12px; border:none; background:none; text-align:left; cursor:pointer; font-size:15px; color:#333;}
  .sidebar button.active {background:#1976d2; color:white;}
  .sidebar button:hover:not(.active) {background:#e0e0e0;}
  .main {flex:1; padding:20px; overflow-y:auto;}
  .panel {display:none;}
  .panel.active {display:block;}
  .section {background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-bottom:25px;}
  .form-row {display:flex; flex-wrap:wrap; gap:20px; margin-bottom:15px;}
  .form-row > * {flex:1 1 200px;}
  input, select, button {padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; width:100%; box-sizing:border-box;}
  button {background:#1976d2; color:white; cursor:pointer; font-weight:600;}
  button:hover {background:#115293;}
  .message {margin-top:10px; font-weight:600; min-height:24px;}
  table {width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 0 5px rgba(0,0,0,0.1);}
  th, td {padding:10px 12px; border-bottom:1px solid #ddd; text-align:left;}
  th {background-color:#1976d2;color:#fff;}
  tr:hover {background:#f1f1f1;}
  .download-button {background:#4caf50; color:white; font-weight:600; padding:8px 12px; border-radius:6px; cursor:pointer; border:none;}
  .download-button:hover {background:#388e3c;}
</style>
</head>
<body>

<header>
  <h1>üìä Auditor Dashboard</h1>
  <button class="back-btn" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Back to Homepage</button>
</header>

<div class="container">
  <div class="sidebar">
    <button class="tab-btn active" data-panel="uploadPanel">Data Upload</button>
    <button class="tab-btn" data-panel="reportPanel">Report</button>
  </div>

  <div class="main">
    
    <!-- Panel 1: Data Upload -->
    <div class="panel active" id="uploadPanel">
      <h2>üì§ Data Upload</h2>

      <!-- Section 1: Manpower Upload -->
      <div class="section">
        <h3>üßë‚Äçüîß Manpower Data Entry</h3>
        <div class="form-row">
          <input type="date" id="mpDate" />
          <select id="mpWarehouse">
            <option value="">Select Warehouse</option>
            <option value="W501">W501</option>
            <option value="W503">W503</option>
            <option value="W504">W504</option>
            <option value="W506">W506</option>
            <option value="W509">W509</option>
            <option value="W511">W511</option>
            <option value="W512">W512</option>
          </select>
          <select id="mpVendor">
            <option value="">Select Vendor</option>
            <option value="Matrix Business Services India Private Limited">Matrix Business Services India Private Limited</option>
            <option value="PRO-Team Solution Pvt Ltd">PRO-Team Solution Pvt Ltd</option>
          </select>
          <input type="number" id="mpCount" placeholder="MP Count" />
        </div>
        <button id="submitMP">Submit Manpower Entry</button>
        <div class="message" id="mpMessage"></div>
      </div>

      <!-- Section 2: CSV Data Upload -->
      <div class="section">
        <h3>üìÅ Upload Counted Data (CSV)</h3>
        <p style="font-size:14px; color:#666;">Please upload the Auditor Counted CSV file.</p>
        <div class="form-row">
          <input type="file" id="fileInput" accept=".csv" />
          <button id="uploadBtn">Upload CSV</button>
        </div>
        <div class="message" id="uploadMsg"></div>
      </div>
    </div>

    <!-- Panel 2: Report -->
    <div class="panel" id="reportPanel">
      <h2>üìã Auditor Report</h2>
      <div class="form-row">
        <input type="date" id="fromDate" />
        <input type="date" id="toDate" />
        <select id="filterWarehouse">
          <option value="">All Warehouses</option>
          <option value="W501">W501</option>
          <option value="W503">W503</option>
          <option value="W504">W504</option>
          <option value="W506">W506</option>
          <option value="W509">W509</option>
          <option value="W511">W511</option>
          <option value="W512">W512</option>
        </select>
        <button id="filterBtn">Filter</button>
        <button class="download-button" id="downloadBtn">Download CSV</button>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>Counted Date</th>
            <th>Warehouse No</th>
            <th>Auditor</th>
            <th>Bin Code</th>
            <th>Verified</th>
            <th>Scanned Qty</th>
            <th>Auditor Qty</th>
            <th>Diff</th>
            <th>Mismatch</th>
            <th>Reverified</th>
            <th>Reverified Phy Qty</th>
            <th>Final Remarks</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
const SUPABASE_URL = 'https://japvvcwuvmstkaljcttu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphcHZ2Y3d1dm1zdGthbGpjdHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA4ODAsImV4cCI6MjA3NTQwNjg4MH0.1wAmrpCxGnCBgV2hOQEn5X7zRsKtbyRaTTqlvuojVYY'; // ‚ö†Ô∏è Replace with your anon/public key
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ======== TAB SWITCHING ========
const tabs = document.querySelectorAll('.tab-btn');
const panels = document.querySelectorAll('.panel');
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    panels.forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.panel).classList.add('active');
  });
});

// ======== MANPOWER ENTRY ========
document.getElementById('submitMP').addEventListener('click', async ()=>{
  const mpDate = document.getElementById('mpDate').value;
  const mpWarehouse = document.getElementById('mpWarehouse').value;
  const mpVendor = document.getElementById('mpVendor').value;
  const mpCount = document.getElementById('mpCount').value;
  const msg = document.getElementById('mpMessage');

  msg.textContent='';
  if(!mpDate || !mpWarehouse || !mpVendor || !mpCount){
    msg.style.color='red';
    msg.textContent='‚ùå Please fill all fields.';
    return;
  }

  const { error } = await supabase.from('Manpower_Data').insert([{
    Date: mpDate,
    "Warehouse No": mpWarehouse,
    Vendor: mpVendor,
    "MP Count": parseInt(mpCount)
  }]);

  if(error){ msg.style.color='red'; msg.textContent=`‚ùå Failed: ${error.message}`; }
  else {
    msg.style.color='green';
    msg.textContent='‚úÖ Manpower data submitted successfully!';
    document.getElementById('mpDate').value='';
    document.getElementById('mpWarehouse').value='';
    document.getElementById('mpVendor').value='';
    document.getElementById('mpCount').value='';
  }
});

// ======== CSV UPLOAD ========
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadMsg = document.getElementById('uploadMsg');

uploadBtn.addEventListener('click', async ()=>{
  uploadMsg.textContent='';
  if(!fileInput.files.length){ uploadMsg.textContent='‚ùå Please select a CSV file.'; return; }
  const file = fileInput.files[0];
  const text = await file.text();
  const data = csvToJson(text);
  const { error } = await supabase.from('Auditor_Counted').insert(data);
  if(error) uploadMsg.textContent=`‚ùå Upload failed: ${error.message}`;
  else { uploadMsg.textContent=`‚úÖ Uploaded ${data.length} rows.`; loadData(); }
});

function csvToJson(csv){
  const lines = csv.trim().split('\n');
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const values = line.split(',').map(v=>v.trim());
    const obj = {};
    headers.forEach((h,i)=>obj[h]=values[i]||'');
    return obj;
  });
}

// ======== AUDITOR REPORT ========
let auditorData = [];
const fromDate = document.getElementById('fromDate');
const toDate = document.getElementById('toDate');
const filterWarehouse = document.getElementById('filterWarehouse');
const filterBtn = document.getElementById('filterBtn');
const downloadBtn = document.getElementById('downloadBtn');
const dataTableBody = document.querySelector('#dataTable tbody');

filterBtn.addEventListener('click', ()=>{
  let filtered=[...auditorData];
  if(fromDate.value) filtered=filtered.filter(r=>r['Counted Date']>=fromDate.value);
  if(toDate.value) filtered=filtered.filter(r=>r['Counted Date']<=toDate.value);
  if(filterWarehouse.value) filtered=filtered.filter(r=>r['Warehouse No']===filterWarehouse.value);
  renderTable(filtered);
});

downloadBtn.addEventListener('click', ()=>{
  if(!auditorData.length) return alert('No data to download');
  const headers = Object.keys(auditorData[0]);
  const csvRows=[headers.join(','),...auditorData.map(r=>headers.map(h=>`"${(r[h]||'').replace(/"/g,'""')}"`).join(','))];
  const blob=new Blob([csvRows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`auditor_report_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
});

function renderTable(data){
  dataTableBody.innerHTML='';
  if(!data.length){ dataTableBody.innerHTML='<tr><td colspan="12" style="text-align:center;">No data</td></tr>'; return; }
  data.slice(0,50).forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row['Counted Date']||''}</td>
      <td>${row['Warehouse No']||''}</td>
      <td>${row['Auditor']||''}</td>
      <td>${row['Bin Code']||''}</td>
      <td>${row['Verified']||''}</td>
      <td>${row['Scanned Qty']||''}</td>
      <td>${row['Auditor Qty']||''}</td>
      <td>${row['Diff']||''}</td>
      <td>${row['Mismatch']||''}</td>
      <td>${row['Reverified']||''}</td>
      <td>${row['Reverified Phy Qty']||''}</td>
      <td>${row['Final Remarks']||''}</td>`;
    dataTableBody.appendChild(tr);
  });
}

async function loadData(){
  const { data, error } = await supabase.from('Auditor_Counted').select('*').order('Counted Date',{ascending:false}).limit(100);
  if(!error){ auditorData=data||[]; renderTable(auditorData); }
}

loadData();
</script>
</body>
</html>
